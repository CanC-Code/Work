name: Quantize Assets for Termux
on: [workflow_dispatch]

jobs:
  build-and-prep:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with Submodules
        uses: actions/checkout@v4
        with:
          repository: leejet/stable-diffusion.cpp
          ref: master
          submodules: 'recursive'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake build-essential

      - name: Build Project
        run: |
          mkdir build && cd build
          cmake ..
          cmake --build . --config Release -j $(nproc)

      - name: Download Files
        run: |
          # Download Motion Module (1.8GB)
          curl -L -o mm_sd_v15_v2.ckpt "https://huggingface.co/guoyww/animatediff-motion-adapter-v1-5/resolve/main/mm_sd_v15_v2.ckpt?download=true"
          # Download Tiny VAE (10MB)
          curl -L -o taesd.gguf "https://huggingface.co/leejet/stable-diffusion.cpp/resolve/main/models/taesd.gguf?download=true"

      - name: Quantize Motion Module
        run: |
          ./build/bin/sd-cli -M convert -m mm_sd_v15_v2.ckpt -o mm_sd_v15_v2_Q4_K.gguf --type q4_k

      - name: Upload Termux Assets
        uses: actions/upload-artifact@v4
        with:
          name: sd-mobile-assets
          path: |
            mm_sd_v15_v2_Q4_K.gguf
            taesd.gguf
